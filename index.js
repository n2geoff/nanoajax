(function(riot) {
    riot.http = function (params, callback) {
        // Any variable used more than once is var'd here because
        // minification will munge the variables whereas it can't munge
        // the object access.
        var headers = params.headers || {}
        , body = params.body
        , method = params.method || (body ? 'POST' : 'GET')
        , called = false

        var req = getRequest(params.cors)

        var reqfields = [
            'responseType', 'withCredentials', 'timeout', 'onprogress'
        ]

        function getRequest(cors) {
            // XDomainRequest is only way to do CORS in IE 8 and 9
            // But XDomainRequest isn't standards-compatible
            // Notably, it doesn't allow cookies to be sent or set by servers
            // IE 10+ is standards-compatible in its XMLHttpRequest
            // but IE 10 can still have an XDomainRequest object, so we don't want to use it
            if (cors && window.XDomainRequest && !/MSIE 1/.test(navigator.userAgent))
            return new XDomainRequest
            if (window.XMLHttpRequest)
            return new XMLHttpRequest
        }

        function setDefault(obj, key, value) {
            obj[key] = obj[key] || value
        }

        function cb(statusCode, responseText) {
            return function () {
                if (!called) {
                    callback(req.status === undefined ? statusCode : req.status,
                        req.status === 0 ? "Error" : (req.response || req.responseText || responseText),
                        req)
                        called = true
                }
            }
        }

        req.open(method, params.url, true)

        var success = req.onload = cb(200)
        req.onreadystatechange = function () {
            if (req.readyState === 4) success()
        }
        req.onerror = cb(null, 'Error')
        req.ontimeout = cb(null, 'Timeout')
        req.onabort = cb(null, 'Abort')

        if (body) {
            setDefault(headers, 'X-Requested-With', 'XMLHttpRequest')

            if (!window.FormData || !(body instanceof window.FormData)) {
                setDefault(headers, 'Content-Type', 'application/x-www-form-urlencoded')
            }
        }

        for (var i = 0, len = reqfields.length, field; i < len; i++) {
            field = reqfields[i]
            if (params[field] !== undefined)
            req[field] = params[field]
        }

        for (var field in headers)
        req.setRequestHeader(field, headers[field])

        req.send(body)

        return req
    };
})(riot || {});
